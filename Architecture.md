# 架构漫谈

Architecture is like teenage sex, everybody talks about it, nobody really knows what is it.
# 聊聊架构

## 第9章 切分的原则

### 架构切分的原则

被切分的生命周期，如果必须要生命周期的主体在连续时间内持续执行，而且不能够被打断并更换生命周期主体的话，就不能切分出去。
每个生命周期的负责人，对所负责生命周期的权利和义务必须是对等的。
切分出来的生命周期，不应该超出一个自然人的负载。
切分是内部活动，内部无论怎么切，对整个系统的外部都应该是透明的。
总结

架构的切分的导火索是人的负载太重，也就是时间不够。
架构的切分实际就是对利益相关人的利益进行切分或合并，使得每个利益相关人的权责是对等的，每个利益相关人可以为自己的利益负责。
架构切分的最终结果都会体现在组织架构上，只有这样才能够让架构落地并推进。
架构切分的结果一定是一个树状，这也是为什么会产生分层。层数越多沟通越多，效率越低，分层要越小越好。尽可能变成一棵平衡树，才能让整个系统的效率最大化。
## 第11章 什么是架构师

架构的目的就是为了增长。

架构师要发现问题的主体，并确定核心问题。

架构师要对总体增长的效果负责，那么自然意味着要能调动资源，也要有权利分配。

架构师要时时把**增长**放在自己的第一考虑要素，把**识别核心生命周期及其主体**作为第一思考，这样才能确保权利的合理分配，保证增长的效率。

## 第15章 什么是软件架构师

作为软件架构师，必须时刻把对软件的生命周期和业务的生命周期的**识别**放在第一位。

对于软件生命周期，必须要深入思考软件开发的生命周期和软件运行的生命周期。

在代码层面，要对业务代码和访问代码做好架构拆分。

软件架构师需要去拆分生命周期，并要形成组织架构去落实架构执行。

架构师的核心在于架构的执行。

人类架构的核心就是组织架构，正确的组织架构才能保证架构的执行。

架构师和技术人员的分工配合：架构师拆分生命周期，技术人员实现生命周期。

技术：软件技术和业务技术。

技术人员如果要成为架构师，就必须跳出技术的视角，换一个角度去看技术。要把时间花在研究生命周期规律和业务的增长上，花在选择合适的技术上，而不只是追求新潮的或自己喜欢的技术。

## 第16章 业务、架构和技术三者的关系

技术：通过人为创造条件，让指定的规律按照人类的意愿发生，这就是技术。

业务：所谓业务，就是要解决人类的问题，目的是为了支撑人类自身的生命周期，使人类获得利益。

技术总是在人类对业务目标要求不断提高的情况下产生，其目的是为了获取更大的利益。所以：

1. 技术是为了解决业务问题儿产生的，没有了业务，技术也就没有了存在的前提。
2. 有了更好的技术后，效率较差的技术，就会慢慢地被淘汰，从而消失，一切都遵从人类的利益诉求。

关系：

业务是核心，技术是解决业务问题的工具，而架构是让业务长大的组织方法。

架构需要用技术来实现拆分，而技术需要架构来合理组织，以提升效率。

## 第17章 软件研发

软件的开发生命周期：
- 确定业务需求
- 编码
- 测试
- 上线

软件架构师要学习业务的架构，根据业务特点确定软件开发的核心生命周期，根据业务组织架构确定软件的拆分和架构：

- 组织软件工程师进行有效的分工，形成软件开发团队的组织架构。
- 为了减轻软件工程师的负担，要把软件开发过程中的非核心生命周期拆分出来，形成软件开发本身的业务架构，并通过自动化来提升软件工程师的开发效率。

软件所面对的共有三大业务领域及其所对应的架构：
1. 业务领域，由业务组织架构来推动业务的架构，即业务生命周期的拆分；
2. 软件开发业务领域，由软件开发的业务组织架构来推动软件的业务架构，如软件的研发流程、角色分工等。所形成的是软件开发模式，不同角色的分工模型；
3. 软件运行业务领域，由软件的开发工程师来负责编写代码，形成软件的架构，并支撑软件的运行。对不同的软件开发工程师进行分工，形成不同的软件开发工程师组织架构，以支撑不同的软件，与软件的架构相匹配。

软件工程师负责建设，软件架构师负责组织。

软件架构师的主要职责:
1. 理解业务组织架构，业务组织架构支撑并推进业务架构，背后的原因是对业务生命周期的拆分。
2. 根据业务生命周期的特点和软件开发生命周期的特点，形成了软件开发本身的业务体系，以及对软件开发生命周期的拆分，也就是软件开发的业务架构。
3. 根据对业务生命周期以及软件开发生命周期的拆分，形成了和两者都相匹配的软件开发团队的组织架构。
4. 对软件进行架构拆分，匹配业务架构和软件开发的业务架构。

## 第18章 软件的架构拆分

**软件开发团队的拆分：**
一个业务团队对应一个软件开发团队。

这个方式要求每个业务部分都有独立的软件开发团队来配合。每个软件开发团队只对应一个业务团队，这样形成的软件边界都很清楚，沟通也很高效。业务团队和对应的软件开发团队能够形成合力，共同解决该团队的业务问题。

这种方式会让软件开发团队的组织也形成一棵组织架构树，并且这棵树和业务团队的组织架构树是匹配的。

**软件的拆分：**
一个软件开发团队开发一个软件。这样每个软件的职责非常明确，沟通也会比较简单，这是最好的状况。

这时形成的还是一棵树。软件和软件之间的关系，反应的就是组织和组织之间的关系，一一对应，还是一棵树。

**软件拆分的第二动力：**
影响软件拆分的动力就是**流量的增长**。也就是希望单位时间内可以处理更多的业务。一方面流量增长导致了业务本身的拆分，进一步导致了软件的拆分；另一方面，某个软件本身流量的增长也会导致该软件自身的拆分。根本问题都在流量的增长上。从这个角度看，流量增长是所有企业都追求的目标，只有更多的流量，业务才能够做大，良好的架构则是流量增长的保证。

## 第19章 如何写好代码

代码主要由两部分组成：

1. 表达业务生命周期的代码。很多人把这部分叫作业逻辑(Domain Logic)，或者叫业务模型(Domain Model)。
2. 表达用户访问生命周期的代码。

**内聚**：是指某个生命周期的变化是累积在一个生命周期主体上的，而不是分散在不同的主题上。

### 服务访问业务逻辑的生命周期
- 业务状态获取
- 业务访问
- 业务状态保存

### 代码可以划分为一下几个责任
1. 服务专注于用户的需求，通过组织黏合代码，也就是虚拟人所提供的生命周期活动完成需求。
2. 黏合代码专注于管理业务中对象的生命周期，并且通过存储保存或加载业务中对象的状态，实现对业务虚拟人的模拟。
3. 业务专注于实现业务的生命周期活动。
4. 存储专注于数据的保存和加载，并让数据和存储设备的存储粒度一一对应。

### 业务逻辑

**内聚**：
    内聚就是要确保一个事物的生命周期是完整的，而不是分裂的。所谓完整，就是指一个生命周期的主体，从生到死的整个过程中，所发生的行为和状态是累积在一个主体上的。

### 业务逻辑分散的危害

(1). 如果服务代码中混入了业务逻辑，则服务做了两件或者两件以上的事情。服务本身的责任是访问逻辑，这是顺序执行。加入了业务逻辑就表明做了两件或者两件以上的事情。可以分为以下两种情况：
a. 典型的情况就是不同的访问生命周期合并在一个服务中来实现。
b. 如果是有计算的逻辑的话，比如受益计算、订单金额计算等，那么这部分应该是业务代码需要完成的，不能交给服务代码来实现。

(2). 黏合代码里面如果包含业务逻辑的话，也会做两件或者两件以上的事情，会和服务代码一样，遇到同样的问题。

(3). 存储代码里面如果混入了业务逻辑，则会导致业务逻辑进入到存储设备中。

### 业务逻辑内聚的好处

1. 由于服务、黏合代码和存储里面的代码都是严格的访问代码，而访问代码的特征就是简单的顺序调用，因此这些代码只要做连通性测试即可。只要保证访问都是连通的就没有问题，不需要单元测试。这是真正的组合。

2. 由于业务不访问任何计算机设备相关的上下文，不访问任何具体的设备，如数据库、缓存、中间件等，因为其状态是靠黏合代码来填充的，因此这部分代码是非常容易写单元测试的，而且单元测试必须保证100%覆盖。

3. 存储如果没有逻辑，则很容易按照存储设备本身的最小访问粒度来完成工作。比如关系型数据库(DataBase, DB)就完全可以做到单表访问。由于存储设备只关心存取数据且和业务没有关系，做表的拆分也是非常容易的事情，所以存储设备通过增加机器就可以横向扩展长大。

4. 服务代码、黏合代码和存储代码只有变简单了，才可以让开发人员投入更多时间来研究业务。毕竟模拟业务才是软件所真正服务的对象。

### 代码架构实例
注意点：

1. 不能把业务模型(Business Model)当做数据对象来处理。
2. 服务代码里不要考虑代码重用。
3. 业务模型是必须要重用的。

## 第20章 单元测试

单元测试 - Unit Test

**单元**：代码调用的最小单位。实际上指的是一个功能块(Function)或者方法(Method)。

**单元测试**指的就是对这些代码调用单元的测试。

单元测试是一种白盒测试，就是必须要对单元的代码细节很清楚才能做得测试。所以，单元测试的编写和执行都是由软件工程师来做得。

**集成测试**基本都是黑盒测试，主要由测试人员根据软件的功能手册进行测试，需要有专门的测试环境配合。集成测试又分为功能测试、回归测试等。

代码是可单元测试的：

对于一个单元，也就是方法，只要确保输入参数不包含外部环境的上下文，同时内部代码对外部的调用也不包含对环境上下文的访问，这个方法就是可以单元测试的。

### 如何做单元测试

以测试一个目标方法为例，基本上分为三个步骤：

- 构建输入参数，并预测该输入所产生的输出；
- 调用要测试的目标方法，获取输出；
- 检测目标方法的输出是否和预期的输出一致(Assert)。

## 第21章 软件架构和面向对象

大部分时候，业务的变化都是流程的变化，并且都是和用户打交道的部分，也就是用户访问生命周期，所以这一部分的变动最频繁。

### 对象的划分

不亲自体验业务生命周期，就无法理解分工，也就是业务的架构拆分，也就无法识别生命周期的主体。一旦业务分工明确之后，生命周期的主体就确定了，对象的边界也就确定了。该对象的生命周期活动就是该对象的行为，也就是方法；该对象行为的结果是该对象的状态，也就是数据。

## 第22章 软件架构与设计模式

模式的重要特征：重复性和周期性。

###　什么是设计模式

一旦把某个设计作为模式，那么这个设计一定是可以落地实现，而且很可能是已经实现了，并具有良好的效果。这个设计就会被当做模板，作为被解决问题的一个典型解决方案。这类设计被称为设计模式。

### 三类设计模式
- 创建型 Creational
- 结构型 Structural
- 行为型 Behavioral

### 设计模式与架构

软件设计模式本身就是一个架构拆分的结果，只是这个拆分被标准化了，可以被重复使用而已。而设计模式在被使用的时候，则不需要再进行设计，直接使用即可。因此设计模式就变成了一个成熟的技巧或者技术了。

软件设计模式这部分代码其实是有自己的业务领域的，这个领域就是软件的访问生命周期。

### 设计模式的误区

毕竟模式只是关注到了共性，共性只会让解决问题变得更容易、更轻松，因为别人解决过了，有参考，但取法解决真正的问题。而真正要解决问题则是要发现问题的个性，发现了**个性**，共性才能发挥更大的作用。

## 第23章 软件架构和软件框架

框架的特点：

框架往往都是无法单独运行的。软件框架基本都是一个留有扩展余地，为其他代码所引用的代码或类库。如果是可以单独运行的，一般会被称为**服务**。

框架旺旺是为了方便本地定制的，在本地进行改造，和自己的软件结合在一起。

在软件行业，框架和服务的另一个区别在于：软件引用框架是本地引用的方式，而服务是用来远程调用的。

## 第24章 软件运维

软件运维其实就是指软件的运行和维护。

### 运维的业务模型

运维的业务目标是保证用户的访问生命周期不受影响。

非核心生命周期的意思并非说该生命周期不重要，而是不再需要自己亲自干，可以分工出去让别人干，用来提高**并行度**。

### 控制变化

运维的生命周期是从软件部署开始的。

每次变化的风险控制是最重要的任务。

1. 隔离
2. 如何隔离：环境隔离
3. 控制变更：被动变更，主动变更。
4. 监控变更
5. 预警变更
6. 主导变更：
7. 提升变更质量

发布：变更在生产环境的执行一般称之为发布，对变更进行管理的系统叫做发布系统。

生产事故时要优先恢复用户的正常访问，而不是在生产环境探查问题的根本原因。

生产环境的问题，基本都是变更造成的问题，优先回退最近的变更，恢复业务的正常运行。也就意味着，**所有的发布都必须做好回退的方案**，一般没有回退计划的发布是不允许执行的。

## 第25章 软件访问生命周期

集群：集群就是装有相同软件，具备同样功能的一组计算机，组织在一起共同服务于客户的访问。